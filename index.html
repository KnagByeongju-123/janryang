<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì”ëŸ‰ í˜¼ì… ë°©ì§€ ì‹œìŠ¤í…œ (QRì½”ë“œ)</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    /* ìŠ¤íƒ€ì¼: ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
    body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; text-align: center; user-select: none; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; background: white; min-height: 100vh; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    h2 { margin-bottom: 20px; color: #333; font-size: 1.5rem; }
    
    .screen { display: none; animation: fadeIn 0.3s; }
    .active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ë²„íŠ¼ë“¤ */
    .btn-worker { width: 100%; padding: 18px 8px; margin: 5px 0; font-size: 1.05rem; cursor: pointer; background: #4a90e2; color: white; border: none; border-radius: 8px; transition: background 0.2s; }
    .btn-worker:active { background: #357abd; transform: scale(0.98); }
    
    #worker-list { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    /* QR ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ */
    #qr-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #qr-modal-content {
      background: white;
      padding: 20px;
      border-radius: 12px;
      position: relative;
      max-width: 450px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #preview-container {
      width: 100%;
      height: 300px;
      border: 3px solid #4a90e2;
      border-radius: 8px;
      background: #000;
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .qr-modal-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }

    .qr-scan-info {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 10px;
    }

    #closeQrModal {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      font-size: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      z-index: 1001;
    }

    #closeQrModal:active {
      transform: scale(0.95);
    }

    /* QR ì¸ì‹ ê²°ê³¼ ë°•ìŠ¤ */
    .qr-result-display {
      background: #e8f5e9;
      border: 2px solid #4caf50;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: none;
      order: -1;
    }

    .qr-result-display.show {
      display: block;
    }

    .qr-result-display h3 {
      margin: 0 0 10px 0;
      color: #2e7d32;
      font-size: 1.1rem;
    }

    .qr-result-value {
      font-size: 1.2rem;
      font-weight: bold;
      color: #1565c0;
      word-break: break-all;
      padding: 8px;
      background: #f5f5f5;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .qr-modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .btn-qr-use, .btn-qr-retry {
      flex: 1;
      padding: 12px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn-qr-use {
      background: #4caf50;
      color: white;
    }

    .btn-qr-use:active {
      background: #3d8b40;
      transform: scale(0.98);
    }

    .btn-qr-retry {
      background: #ff9800;
      color: white;
    }

    .btn-qr-retry:active {
      background: #e68900;
      transform: scale(0.98);
    }

    /* í‚¤íŒ¨ë“œ */
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .key-btn { padding: 20px; font-size: 1.5rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; }
    .key-btn:active { background: #e2e6ea; }
    .key-confirm { grid-column: span 3; background: #28a745; color: white; font-weight: bold; }
    
    /* ìˆ˜ëŸ‰ ì…ë ¥ì°½ */
    input[type="text"] { width: 90%; padding: 15px; font-size: 1.5rem; text-align: center; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
    input:focus { border-color: #4a90e2; outline: none; background: #fff; }

    /* ê²°ê³¼ì°½ */
    .result-box { font-size: 5rem; font-weight: bold; margin: 40px 0; }
    .res-ok { color: #28a745; }
    .res-ng { color: #dc3545; }
    
    /* ìƒì„¸ ì •ë³´ ë°•ìŠ¤ */
    .info-box { background: #f1f3f5; padding: 20px; border-radius: 10px; text-align: left; margin-bottom: 20px; font-size: 1.1rem; line-height: 1.6; }
    .info-box span { font-weight: bold; color: #333; float: right; }

    .btn-finish { width: 100%; padding: 20px; font-size: 1.3rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; }
    .btn-finish:active { background: #5a6268; transform: scale(0.98); }
    
    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #loading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); color:white; font-size:2rem; padding-top:50%; z-index:999; }
  </style>
</head>
<body>

<div class="container">

  <!-- 1ë‹¨ê³„: ì‘ì—…ì ì„ íƒ -->
  <div id="step-1" class="screen active">
    <h1 style="color: #dc3545; font-size: 2rem; margin-bottom: 30px;">ì”ëŸ‰ê´€ë¦¬ ì²´í¬ì‹œíŠ¸</h1>
    <h2>ì‘ì—…ì ì„ íƒ</h2>
    <div id="worker-list">
      <button class="btn-worker" onclick="selectWorker('ì˜¤ìœ¤ì •')">ì˜¤ìœ¤ì •</button>
      <button class="btn-worker" onclick="selectWorker('ê¹€ë¯¸ì„ ')">ê¹€ë¯¸ì„ </button>
      <button class="btn-worker" onclick="selectWorker('ê¶Œí˜œì˜')">ê¶Œí˜œì˜</button>
      <button class="btn-worker" onclick="selectWorker('ì „ìˆœì§„')">ì „ìˆœì§„</button>
      <button class="btn-worker" onclick="selectWorker('í•˜ì •í™”')">í•˜ì •í™”</button>
      <button class="btn-worker" onclick="selectWorker('ì†¡ê²½ì˜¥')">ì†¡ê²½ì˜¥</button>
      <button class="btn-worker" onclick="selectWorker('ì´ìœ ì„ ')">ì´ìœ ì„ </button>
      <button class="btn-worker" onclick="selectWorker('ê°•ë€í¬')">ê°•ë€í¬</button>
    </div>
  </div>

  <!-- 2ë‹¨ê³„: A ë°•ìŠ¤ QR ìŠ¤ìº” -->
  <div id="step-2" class="screen">
    <h2>[A] ì›ë³¸ ë°•ìŠ¤ QR ìŠ¤ìº”</h2>
    <p style="color: #666; margin-bottom: 15px;">ì›ë³¸ ë°•ìŠ¤ì˜ QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</p>
    <button class="btn-finish" onclick="openQrScannerA()" style="background: #4a90e2;">ğŸ“± QR ìŠ¤ìº” ì‹œì‘</button>
    <button class="btn-finish" onclick="goBackToStep1()" style="background: #dc3545; margin-top: 10px;">ì·¨ì†Œ</button>
  </div>

  <!-- 3ë‹¨ê³„: ìˆ˜ëŸ‰ ì…ë ¥ -->
  <div id="step-3" class="screen">
    <h2>ìˆ˜ëŸ‰ ë“±ë¡</h2>
    <input type="text" id="input-qty" readonly placeholder="0">
    <div class="keypad">
      <button class="key-btn" onclick="addQty(1)">1</button>
      <button class="key-btn" onclick="addQty(2)">2</button>
      <button class="key-btn" onclick="addQty(3)">3</button>
      <button class="key-btn" onclick="addQty(4)">4</button>
      <button class="key-btn" onclick="addQty(5)">5</button>
      <button class="key-btn" onclick="addQty(6)">6</button>
      <button class="key-btn" onclick="addQty(7)">7</button>
      <button class="key-btn" onclick="addQty(8)">8</button>
      <button class="key-btn" onclick="addQty(9)">9</button>
      <button class="key-btn" onclick="clearQty()">C</button>
      <button class="key-btn" onclick="addQty(0)">0</button>
      <button class="key-btn key-confirm" onclick="confirmQty()">ì…ë ¥ ì™„ë£Œ</button>
    </div>
  </div>

  <!-- 4ë‹¨ê³„: B ë°•ìŠ¤ QR ìŠ¤ìº” -->
  <div id="step-4" class="screen">
    <h2>[B] ì”ëŸ‰ ë°•ìŠ¤ QR ìŠ¤ìº”</h2>
    <p style="color: #666; margin-bottom: 15px;">ì”ëŸ‰ ë°•ìŠ¤ì˜ QRì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”</p>
    <button class="btn-finish" onclick="openQrScannerB()" style="background: #4a90e2;">ğŸ“± QR ìŠ¤ìº” ì‹œì‘</button>
    <button class="btn-finish" onclick="goBackToStep3()" style="background: #dc3545; margin-top: 10px;">ì·¨ì†Œ</button>
  </div>

  <!-- 5ë‹¨ê³„: íŒì • ê²°ê³¼ -->
  <div id="step-5" class="screen">
    <h2>íŒì • ê²°ê³¼</h2>
    <div id="result-display" class="result-box"></div>
    
    <div class="info-box">
      <div>ì‘ì—…ì <span id="disp-worker"></span></div>
      <div>ì›ë³¸(A) <span id="disp-a"></span></div>
      <div>ëŒ€ìƒ(B) <span id="disp-b"></span></div>
      <div>ìˆ˜ëŸ‰ <span id="disp-qty"></span></div>
    </div>

    <button id="btn-finish" class="btn-finish" onclick="saveData()">ì™„ë£Œ (ì„œë²„ ì €ì¥)</button>
  </div>

</div>

<!-- QR ìŠ¤ìº” ëª¨ë‹¬ -->
<div id="qr-modal">
  <div id="qr-modal-content">
    <button id="closeQrModal" onclick="closeQrModal()">&times;</button>
    <div id="preview-container"></div>
    
    <div class="qr-result-display" id="qr-result-display">
      <h3>âœ“ QRì½”ë“œ ì¸ì‹ë¨</h3>
      <div class="qr-result-value" id="qr-result-text"></div>
      <div class="qr-modal-buttons">
        <button class="btn-qr-use" onclick="useQrValue()">ì´ ê°’ ì‚¬ìš©</button>
        <button class="btn-qr-retry" onclick="retryQrScan()">ë‹¤ì‹œ ìŠ¤ìº”</button>
      </div>
    </div>
  </div>
</div>

<div id="loading">ì €ì¥ ì¤‘...</div>

<script>
  // -----------------------------------------------------------
  // [ì„¤ì •] ì•„ë˜ URLì„ Google Apps Script ì›¹ ì•± URLë¡œ êµì²´í•˜ì„¸ìš”
  // -----------------------------------------------------------
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz-spORG3FgGC6E4moEsvUQe3UcZ-0Xs9Iq8lWrTeHgraS3HKYwQRmppMMQQpI_vhLW/exec";

  let appData = { worker: '', codeA: '', qty: '', codeB: '', result: '' };
  let html5QrCodeScanner = null;
  let currentScanTarget = null; // 'A' ë˜ëŠ” 'B'
  let lastQrCode = null;

  // í™”ë©´ ì „í™˜
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // ============================================
  // 1. ì‘ì—…ì ì„ íƒ
  // ============================================
  function selectWorker(name) {
    appData.worker = name;
    showScreen('step-2');
  }

  // ============================================
  // 2. A ë°•ìŠ¤ QR ìŠ¤ìº”
  // ============================================
  function openQrScannerA() {
    currentScanTarget = 'A';
    lastQrCode = null;
    document.getElementById('qr-result-display').classList.remove('show');
    document.getElementById('qr-result-text').innerText = '';
    openQrModal();
  }

  function goBackToStep1() {
    showScreen('step-1');
  }

  // ============================================
  // 3. ìˆ˜ëŸ‰ ì…ë ¥ (í‚¤íŒ¨ë“œ)
  // ============================================
  function addQty(n) { 
    document.getElementById('input-qty').value += n; 
  }
  function clearQty() { 
    document.getElementById('input-qty').value = ''; 
  }
  function confirmQty() {
    const val = document.getElementById('input-qty').value;
    if(!val) {
      alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }
    appData.qty = val;
    showScreen('step-4');
  }

  // ============================================
  // 4. B ë°•ìŠ¤ QR ìŠ¤ìº”
  // ============================================
  function openQrScannerB() {
    currentScanTarget = 'B';
    lastQrCode = null;
    document.getElementById('qr-result-display').classList.remove('show');
    document.getElementById('qr-result-text').innerText = '';
    openQrModal();
  }

  function goBackToStep3() {
    showScreen('step-3');
  }

  // ============================================
  // QR ëª¨ë‹¬ ì œì–´
  // ============================================
  function openQrModal() {
    document.getElementById('qr-modal').style.display = 'flex';
    startQrScanner();
  }

  function closeQrModal() {
    stopQrScanner();
    document.getElementById('qr-modal').style.display = 'none';
  }

  // ============================================
  // QR ìŠ¤ìº” ì‹œì‘/ì¢…ë£Œ
  // ============================================
  function startQrScanner() {
    const previewId = 'preview-container';
    
    try {
      html5QrCodeScanner = new Html5Qrcode(previewId);
      html5QrCodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 300, height: 300 } },
        (decodedText) => {
          // QR ì½”ë“œê°€ ê°ì§€ë˜ë©´ ê²°ê³¼ í‘œì‹œ
          if (decodedText && decodedText !== lastQrCode) {
            lastQrCode = decodedText;
            document.getElementById('qr-result-text').innerText = decodedText;
            document.getElementById('qr-result-display').classList.add('show');
            html5QrCodeScanner.pause(); // ìŠ¤ìº” ì¼ì‹œ ì¤‘ì§€
          }
        },
        (errorMessage) => {
          // ë¬´ì‹œ - ê³„ì† ìŠ¤ìº”
        }
      ).catch(err => {
        alert("ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: " + err);
        console.error(err);
        closeQrModal();
      });
    } catch (err) {
      alert("QR ìŠ¤ìºë„ˆ ì´ˆê¸°í™” ì‹¤íŒ¨: " + err);
      console.error(err);
      closeQrModal();
    }
  }

  function stopQrScanner() {
    if (html5QrCodeScanner) {
      html5QrCodeScanner.stop()
        .then(() => {
          html5QrCodeScanner.clear();
          html5QrCodeScanner = null;
        })
        .catch(err => console.error("ìŠ¤ìº” ì¤‘ì§€ ì˜¤ë¥˜:", err));
    }
  }

  function useQrValue() {
    const qrValue = document.getElementById('qr-result-text').innerText;
    
    if (currentScanTarget === 'A') {
      appData.codeA = qrValue;
      closeQrModal();
      showScreen('step-3');
    } else if (currentScanTarget === 'B') {
      appData.codeB = qrValue;
      closeQrModal();
      compareAndShow();
    }
  }

  function retryQrScan() {
    document.getElementById('qr-result-display').classList.remove('show');
    document.getElementById('qr-result-text').innerText = '';
    lastQrCode = null;
    if (html5QrCodeScanner) {
      html5QrCodeScanner.resume();
    }
  }

  // ============================================
  // 5. íŒì • ê²°ê³¼
  // ============================================
  function compareAndShow() {
    // ë¬¸ìì—´ ë‹¨ìˆœ ë¹„êµ
    if(appData.codeA === appData.codeB) {
      appData.result = "OK";
      document.getElementById('result-display').innerHTML = '<span class="res-ok">OK</span>';
      // OK: ì§„ë™ 2íšŒ (200ms ì§„ë™, 100ms ì‰¬ê¸°, 200ms ì§„ë™)
      if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
      }
    } else {
      appData.result = "NG";
      document.getElementById('result-display').innerHTML = '<span class="res-ng">NG</span>';
      // NG: ì§„ë™ 5íšŒ (100ms ì§„ë™, 100ms ì‰¬ê¸° ë°˜ë³µ)
      if (navigator.vibrate) {
        navigator.vibrate([100, 100, 100, 100, 100, 100, 100, 100, 100]);
      }
    }
    
    // ì •ë³´ í‘œì‹œ
    document.getElementById('disp-worker').innerText = appData.worker;
    document.getElementById('disp-a').innerText = appData.codeA;
    document.getElementById('disp-b').innerText = appData.codeB;
    document.getElementById('disp-qty').innerText = appData.qty;
    
    showScreen('step-5');
  }

  // ============================================
  // 6. ì„œë²„ ì €ì¥
  // ============================================
  function saveData() {
    const btn = document.getElementById('btn-finish');
    const loading = document.getElementById('loading');
    
    if(btn.disabled) return;
    btn.disabled = true;
    loading.style.display = 'block';

    fetch(GOOGLE_SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(appData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.status);
      }
      return response.text();
    })
    .then(result => {
      alert("ì €ì¥ ì™„ë£Œ!");
      location.reload();
    })
    .catch(error => {
      console.error('Error:', error);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      btn.disabled = false;
      loading.style.display = 'none';
    });
  }

  // ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
  document.getElementById('qr-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeQrModal();
    }
  });
</script>

</body>

</html>
