<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì”ëŸ‰ í˜¼ì… ë°©ì§€ ì‹œìŠ¤í…œ (QRì½”ë“œ)</title>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    /* ìŠ¤íƒ€ì¼: ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
    body { font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; margin: 0; padding: 0; background-color: #f0f2f5; text-align: center; user-select: none; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; background: white; min-height: 100vh; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    h2 { margin-bottom: 20px; color: #333; font-size: 1.5rem; }
    
    .screen { display: none; animation: fadeIn 0.3s; }
    .active { display: block; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* ë²„íŠ¼ë“¤ */
    .btn-worker { width: 100%; padding: 25px; margin: 8px 0; font-size: 1.2rem; cursor: pointer; background: #4a90e2; color: white; border: none; border-radius: 12px; transition: background 0.2s; }
    .btn-worker:active { background: #357abd; transform: scale(0.98); }
    
    /* QR ìŠ¤ìº” ì˜ì—­ */
    .qr-scanner-wrapper { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      margin: 20px 0;
    }

    #qr-video { 
      width: 100%; 
      max-width: 350px; 
      height: 350px; 
      border: 3px solid #4a90e2; 
      border-radius: 12px; 
      background: #000; 
      object-fit: cover;
      margin-bottom: 15px;
    }

    .qr-overlay-frame { 
      position: relative; 
      width: 100%; 
      max-width: 350px; 
      aspect-ratio: 1; 
      margin-bottom: 15px;
    }

    .qr-overlay-frame::after { 
      content: ''; 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      width: 280px; 
      height: 280px; 
      border: 3px solid #4a90e2; 
      border-radius: 12px; 
      box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); 
      pointer-events: none; 
    }

    /* QR ì¸ì‹ ê²°ê³¼ í‘œì‹œ */
    .qr-result-box { 
      background: #e8f5e9; 
      border: 2px solid #4caf50; 
      padding: 15px; 
      border-radius: 8px; 
      margin: 15px 0; 
      display: none;
    }

    .qr-result-box.show { display: block; }
    .qr-result-box h3 { margin: 0 0 10px 0; color: #2e7d32; }
    .qr-result-value { 
      font-size: 1.3rem; 
      font-weight: bold; 
      color: #1565c0; 
      word-break: break-all;
      margin-bottom: 15px;
    }

    .qr-result-buttons { 
      display: flex; 
      gap: 10px; 
      justify-content: center;
    }

    .btn-qr-confirm, .btn-qr-rescan { 
      flex: 1; 
      padding: 12px; 
      font-size: 1rem; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: bold;
    }

    .btn-qr-confirm { 
      background: #4caf50; 
      color: white; 
    }

    .btn-qr-rescan { 
      background: #ff9800; 
      color: white; 
    }

    /* ìŠ¤ìº” ìƒíƒœ í…ìŠ¤íŠ¸ */
    .scan-status { 
      font-size: 0.95rem; 
      color: #666; 
      margin: 10px 0;
    }

    .scan-status.scanning { 
      color: #4a90e2; 
      font-weight: bold;
    }

    /* ì·¨ì†Œ ë²„íŠ¼ */
    .btn-cancel { 
      width: 100%; 
      padding: 15px; 
      font-size: 1.1rem; 
      background: #dc3545; 
      color: white; 
      border: none; 
      border-radius: 8px; 
      cursor: pointer; 
      margin-top: 10px;
    }

    .btn-cancel:active { 
      background: #c82333; 
      transform: scale(0.98);
    }

    /* í‚¤íŒ¨ë“œ */
    .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; }
    .key-btn { padding: 20px; font-size: 1.5rem; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; cursor: pointer; }
    .key-btn:active { background: #e2e6ea; }
    .key-confirm { grid-column: span 3; background: #28a745; color: white; font-weight: bold; }
    
    /* ìˆ˜ëŸ‰ ì…ë ¥ì°½ */
    input[type="text"] { width: 90%; padding: 15px; font-size: 1.5rem; text-align: center; border: 2px solid #ddd; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
    input:focus { border-color: #4a90e2; outline: none; background: #fff; }

    /* ê²°ê³¼ì°½ */
    .result-box { font-size: 5rem; font-weight: bold; margin: 40px 0; }
    .res-ok { color: #28a745; }
    .res-ng { color: #dc3545; }
    
    /* ìƒì„¸ ì •ë³´ ë°•ìŠ¤ */
    .info-box { background: #f1f3f5; padding: 20px; border-radius: 10px; text-align: left; margin-bottom: 20px; font-size: 1.1rem; line-height: 1.6; }
    .info-box span { font-weight: bold; color: #333; float: right; }

    .btn-finish { width: 100%; padding: 20px; font-size: 1.3rem; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; }
    
    /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
    #loading { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); color:white; font-size:2rem; padding-top:50%; z-index:999; }

    /* ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ë©”ì‹œì§€ */
    .permission-message {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      color: #856404;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- 1ë‹¨ê³„: ì‘ì—…ì ì„ íƒ -->
  <div id="step-1" class="screen active">
    <h2>ì‘ì—…ì ì„ íƒ</h2>
    <div id="worker-list">
      <button class="btn-worker" onclick="selectWorker('ì˜¤ìœ¤ì •')">ì˜¤ìœ¤ì •</button>
      <button class="btn-worker" onclick="selectWorker('ê¹€ë¯¸ì„ ')">ê¹€ë¯¸ì„ </button>
      <button class="btn-worker" onclick="selectWorker('ê¶Œí˜œì˜')">ê¶Œí˜œì˜</button>
      <button class="btn-worker" onclick="selectWorker('ì „ìˆœì§„')">ì „ìˆœì§„</button>
      <button class="btn-worker" onclick="selectWorker('í•˜ì •í™”')">í•˜ì •í™”</button>
      <button class="btn-worker" onclick="selectWorker('ì†¡ê²½ì˜¥')">ì†¡ê²½ì˜¥</button>
      <button class="btn-worker" onclick="selectWorker('ì´ìœ ì„ ')">ì´ìœ ì„ </button>
      <button class="btn-worker" onclick="selectWorker('ê°•ë€í¬')">ê°•ë€í¬</button>
      
    
    
    </div>
  </div>

  <!-- 2ë‹¨ê³„: A ë°•ìŠ¤ QR ìŠ¤ìº” -->
  <div id="step-2" class="screen">
    <h2>[A] ì›ë³¸ ë°•ìŠ¤ QR ìŠ¤ìº”</h2>
    <p style="color: #666; margin-bottom: 15px;">ì›ë³¸ ë°•ìŠ¤ì˜ QRì½”ë“œë¥¼ ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”í•˜ì„¸ìš”</p>
    
    <div class="permission-message">
      ğŸ“± ì²« ìŠ¤ìº” ì‹œ ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. 'í—ˆìš©'ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
    </div>

    <div class="qr-scanner-wrapper">
      <video id="qr-video"></video>
      <p class="scan-status scanning" id="scan-status-a">ìŠ¤ìº” ì¤‘...</p>
    </div>

    <div class="qr-result-box" id="qr-result-a">
      <h3>âœ“ QRì½”ë“œ ì¸ì‹ë¨</h3>
      <div class="qr-result-value" id="qr-value-a"></div>
      <div class="qr-result-buttons">
        <button class="btn-qr-confirm" onclick="confirmQrA()">ì´ ê°’ ì‚¬ìš©</button>
        <button class="btn-qr-rescan" onclick="rescanQrA()">ë‹¤ì‹œ ìŠ¤ìº”</button>
      </div>
    </div>

    <button class="btn-cancel" onclick="cancelScanA()">ì·¨ì†Œ</button>
  </div>

  <!-- 3ë‹¨ê³„: ìˆ˜ëŸ‰ ì…ë ¥ -->
  <div id="step-3" class="screen">
    <h2>ìˆ˜ëŸ‰ ë“±ë¡</h2>
    <input type="text" id="input-qty" readonly placeholder="0">
    <div class="keypad">
      <button class="key-btn" onclick="addQty(1)">1</button>
      <button class="key-btn" onclick="addQty(2)">2</button>
      <button class="key-btn" onclick="addQty(3)">3</button>
      <button class="key-btn" onclick="addQty(4)">4</button>
      <button class="key-btn" onclick="addQty(5)">5</button>
      <button class="key-btn" onclick="addQty(6)">6</button>
      <button class="key-btn" onclick="addQty(7)">7</button>
      <button class="key-btn" onclick="addQty(8)">8</button>
      <button class="key-btn" onclick="addQty(9)">9</button>
      <button class="key-btn" onclick="clearQty()">C</button>
      <button class="key-btn" onclick="addQty(0)">0</button>
      <button class="key-btn key-confirm" onclick="confirmQty()">ì…ë ¥ ì™„ë£Œ</button>
    </div>
  </div>

  <!-- 4ë‹¨ê³„: B ë°•ìŠ¤ QR ìŠ¤ìº” -->
  <div id="step-4" class="screen">
    <h2>[B] ì”ëŸ‰ ë°•ìŠ¤ QR ìŠ¤ìº”</h2>
    <p style="color: #666; margin-bottom: 15px;">ì”ëŸ‰ ë°•ìŠ¤ì˜ QRì½”ë“œë¥¼ ì¹´ë©”ë¼ë¡œ ìŠ¤ìº”í•˜ì„¸ìš”</p>

    <div class="qr-scanner-wrapper">
      <video id="qr-video-b"></video>
      <p class="scan-status scanning" id="scan-status-b">ìŠ¤ìº” ì¤‘...</p>
    </div>

    <div class="qr-result-box" id="qr-result-b">
      <h3>âœ“ QRì½”ë“œ ì¸ì‹ë¨</h3>
      <div class="qr-result-value" id="qr-value-b"></div>
      <div class="qr-result-buttons">
        <button class="btn-qr-confirm" onclick="confirmQrB()">ì´ ê°’ ì‚¬ìš©</button>
        <button class="btn-qr-rescan" onclick="rescanQrB()">ë‹¤ì‹œ ìŠ¤ìº”</button>
      </div>
    </div>

    <button class="btn-cancel" onclick="cancelScanB()">ì·¨ì†Œ</button>
  </div>

  <!-- 5ë‹¨ê³„: íŒì • ê²°ê³¼ -->
  <div id="step-5" class="screen">
    <h2>íŒì • ê²°ê³¼</h2>
    <div id="result-display" class="result-box"></div>
    
    <div class="info-box">
      <div>ì‘ì—…ì <span id="disp-worker"></span></div>
      <div>ì›ë³¸(A) <span id="disp-a"></span></div>
      <div>ëŒ€ìƒ(B) <span id="disp-b"></span></div>
      <div>ìˆ˜ëŸ‰ <span id="disp-qty"></span></div>
    </div>

    <button id="btn-finish" class="btn-finish" onclick="saveData()">ì™„ë£Œ (ì„œë²„ ì €ì¥)</button>
  </div>

</div>

<div id="loading">ì €ì¥ ì¤‘...</div>

<script>
  // -----------------------------------------------------------
  // [ì„¤ì •] ì•„ë˜ URLì„ 1ë‹¨ê³„ì—ì„œ ë³µì‚¬í•œ 'ì›¹ ì•± URL'ë¡œ êµì²´í•˜ì„¸ìš”
  // -----------------------------------------------------------
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz-spORG3FgGC6E4moEsvUQe3UcZ-0Xs9Iq8lWrTeHgraS3HKYwQRmppMMQQpI_vhLW/exec";

  let appData = { worker: '', codeA: '', qty: '', codeB: '', result: '' };
  let videoStreamA = null;
  let videoStreamB = null;
  let qrScannerA = null;
  let qrScannerB = null;

  // í™”ë©´ ì „í™˜
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // ============================================
  // 1. ì‘ì—…ì ì„ íƒ
  // ============================================
  function selectWorker(name) {
    appData.worker = name;
    showScreen('step-2');
    setTimeout(() => startQrScanA(), 300);
  }

  // ============================================
  // 2. A ë°•ìŠ¤ QR ìŠ¤ìº”
  // ============================================
  function startQrScanA() {
    const video = document.getElementById('qr-video');
    startQrScanner(video, (qrData) => {
      document.getElementById('qr-value-a').innerText = qrData;
      document.getElementById('qr-result-a').classList.add('show');
    });
    videoStreamA = video.srcObject;
    qrScannerA = setInterval(() => scanQrCode(video), 100);
  }

  function confirmQrA() {
    appData.codeA = document.getElementById('qr-value-a').innerText;
    stopQrScanA();
    document.getElementById('input-qty').value = '';
    showScreen('step-3');
  }

  function rescanQrA() {
    document.getElementById('qr-result-a').classList.remove('show');
    document.getElementById('qr-value-a').innerText = '';
    startQrScanA();
  }

  function cancelScanA() {
    stopQrScanA();
    showScreen('step-1');
  }

  function stopQrScanA() {
    if (videoStreamA) {
      videoStreamA.getTracks().forEach(track => track.stop());
    }
    if (qrScannerA) {
      clearInterval(qrScannerA);
    }
  }

  // ============================================
  // 3. ìˆ˜ëŸ‰ ì…ë ¥ (í‚¤íŒ¨ë“œ)
  // ============================================
  function addQty(n) { 
    document.getElementById('input-qty').value += n; 
  }
  function clearQty() { 
    document.getElementById('input-qty').value = ''; 
  }
  function confirmQty() {
    const val = document.getElementById('input-qty').value;
    if(!val) {
      alert("ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”");
      return;
    }
    appData.qty = val;
    showScreen('step-4');
    setTimeout(() => startQrScanB(), 300);
  }

  // ============================================
  // 4. B ë°•ìŠ¤ QR ìŠ¤ìº”
  // ============================================
  function startQrScanB() {
    const video = document.getElementById('qr-video-b');
    startQrScanner(video, (qrData) => {
      document.getElementById('qr-value-b').innerText = qrData;
      document.getElementById('qr-result-b').classList.add('show');
    });
    videoStreamB = video.srcObject;
    qrScannerB = setInterval(() => scanQrCode(video), 100);
  }

  function confirmQrB() {
    appData.codeB = document.getElementById('qr-value-b').innerText;
    stopQrScanB();
    compareAndShow();
  }

  function rescanQrB() {
    document.getElementById('qr-result-b').classList.remove('show');
    document.getElementById('qr-value-b').innerText = '';
    startQrScanB();
  }

  function cancelScanB() {
    stopQrScanB();
    showScreen('step-3');
  }

  function stopQrScanB() {
    if (videoStreamB) {
      videoStreamB.getTracks().forEach(track => track.stop());
    }
    if (qrScannerB) {
      clearInterval(qrScannerB);
    }
  }

  // ============================================
  // QR ì½”ë“œ ìŠ¤ìº” ë¡œì§ (ê³µí†µ)
  // ============================================
  function startQrScanner(video, onDetect) {
    navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment' } 
    })
    .then(stream => {
      video.srcObject = stream;
      video.play();
    })
    .catch(err => {
      alert("ì¹´ë©”ë¼ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.\nì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
      console.error(err);
    });
  }

  function scanQrCode(video) {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    if (canvas.width === 0 || canvas.height === 0) {
      return; // ë¹„ë””ì˜¤ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ
    }

    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);

    if (code) {
      // QR ì½”ë“œ ê°ì§€ë¨ - ì½œë°± ì‹¤í–‰
      // (ì½œë°±ì€ startQrScanner í˜¸ì¶œ ì‹œ ì „ë‹¬ë¨)
    }
  }

  // ============================================
  // 5. íŒì • ê²°ê³¼
  // ============================================
  function compareAndShow() {
    // ë¬¸ìì—´ ë‹¨ìˆœ ë¹„êµ
    if(appData.codeA === appData.codeB) {
      appData.result = "OK";
      document.getElementById('result-display').innerHTML = '<span class="res-ok">OK</span>';
    } else {
      appData.result = "NG";
      document.getElementById('result-display').innerHTML = '<span class="res-ng">NG</span>';
    }
    
    // ì •ë³´ í‘œì‹œ
    document.getElementById('disp-worker').innerText = appData.worker;
    document.getElementById('disp-a').innerText = appData.codeA;
    document.getElementById('disp-b').innerText = appData.codeB;
    document.getElementById('disp-qty').innerText = appData.qty;
    
    showScreen('step-5');
  }

  // ============================================
  // 6. ì„œë²„ ì €ì¥
  // ============================================
  function saveData() {
    const btn = document.getElementById('btn-finish');
    const loading = document.getElementById('loading');
    
    if(btn.disabled) return;
    btn.disabled = true;
    loading.style.display = 'block';

    fetch(GOOGLE_SCRIPT_URL, {
      method: "POST",
      body: JSON.stringify(appData)
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜: ' + response.status);
      }
      return response.text();
    })
    .then(result => {
      alert("ì €ì¥ ì™„ë£Œ!");
      location.reload();
    })
    .catch(error => {
      console.error('Error:', error);
      alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
      btn.disabled = false;
      loading.style.display = 'none';
    });
  }
</script>

</body>

</html>

